:css
  .intro-header {
    padding-top: 50px;
    padding-bottom: 50px;
    text-align: center;
    color: #f8f8f8;
    background: url(../img/intro-bg.jpg) repeat-y center center;
  }
  .backup-song {
    background-color: #ddd;
  }
  .sname {
    color: #aaa;
    font-size: 60%;
  }

- StyleColor = {'bebop'=>'success', 'boston'=>'info', 'chachacha'=>'danger', 'newwave'=>'danger', 'rumba'=>'warning', 'rhumba'=>'warning', 'slow'=>'warning', 'tango'=>'success', 'techno'=>'danger', 'twist'=>'danger', 'waltz'=>'info'}

- index = 0
- plist.each do |aname, sentry|
  - unless sentry
    - if aname =~/^--/
      %hr/
    - next
  - index += 1
  - rowclass = (sentry[:tags] || []).include?('backup') ? 'backup-song' : ''
  %a(name="s#{index}")
  %div(class="row #{rowclass}")
    .col-md-4
      - pname  = sentry[:pname] || sentry[:name]
      - pstyle = (sentry[:pstyle] || '').downcase
      - href   = sentry[:href]
      %span.sname.pull-right= sentry[:sname]
      %h4
        -#%a(href=href data-toggle="lightbox" data-type="url" data-width="1400" data-height="850")
        %a(href=href)
          = "#{index}. #{pname}"
      %h5
        - btype  = StyleColor[pstyle] || 'secondary'
        - sclass = "small badge badge-#{btype}"
        %div(class=sclass)= sentry[:performer]
        %div(class=sclass)= sentry[:pstyle]
        %div(class=sclass)= sentry[:play_key]
        - soundfile = nil
        - if sentry[:href]
          - sname = sentry[:href].split('/')[5]
          - soundfile = "#{sname}.mp3"
          - start, stop = 0, 90
        - if soundfile && test(?s, "audio/intro-#{soundfile}")
          .pull-right
            - if false
              %a(href='#' onclick="return play_audio('/audio/intro-#{soundfile}', false, #{start}, #{stop+5})" title="Play intro for #{pname}" data-toggle="tooltip")
                %i.fa.fa-play
              %a(href='#' onclick="return stop_audio()")
                %i.fa.fa-pause
              - ['intro', 'solo'].each do |segment|
                - next unless test(?s, "audio/#{segment}-#{soundfile}")
                %a(href='#' onclick="return play_audio('/audio/#{segment}-#{soundfile}', true, #{start}, #{stop})" title="Loop #{segment} for #{pname}" data-toggle="tooltip")
                  %i.fa.fa-repeat
      %p.text-muted= sentry[:preview]
    .col-md-4.intro-header
    .col-md-4
      %h5.pull-right
        %div(class=sclass)= sentry[:pstyle]
        %div(class=sclass)= sentry[:play_key]
        %div(class=sclass)= sentry[:performer]
        - if value = sentry[:play_link]
          %a(href=value target='play_link')
            %i.fa.fa-music
      .text-muted.small= (sentry[:perfnote] || '').gsub(/\n/, "<br/>")
      - if soundfile && test(?s, "audio/intro-#{soundfile}")
        - ['intro', 'solo'].each do |segment|
          - next unless test(?s, "audio/#{segment}-#{soundfile}")
          .pull-right
            = segment
            %audio.pull-right(controls loop)
              %source(src="/audio/#{segment}-#{soundfile}" type="audio/mpeg")

- content_for :javascript do
  %script(src="/js/howler.js")
  :javascript
    var cur_sound  = null;

    function play_audio(file, isloop, start, stop) {
      if (cur_sound != null) {
        cur_sound.stop();
      }
      
      cur_sound = new Howl({
        src:  [file],
        loop: isloop,
        sprite: {
          intro: [start*1000, stop*1000]
        }
      });
      cur_sound.play('intro');
      return false;
    };

    function stop_audio() {
      if (cur_sound != null) {
        cur_sound.stop();
      }
      return false;
    }
    $(document).ready(function() {
      $(document).on('click', '[data-toggle="lightbox"]',
        function(event) {
          event.preventDefault();
          $(this).ekkoLightbox();
        });
      $('[data-toggle="tooltip"]').tooltip({"html":true}); 
    });
